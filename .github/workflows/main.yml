name: Forge Sacred Database

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Clone Arsenal Source
        run: |
          git clone https://github.com/AntiRootkit/exploit-database source_data
          cp source_data/files_exploits.csv exploits.csv

      - name: Run Database Forge
        run: |
          # Criando o script de forja no voo
          cat <<'INNEREOF' > forge_db.py
import sqlite3, csv
conn = sqlite3.connect('duck_base.db')
cursor = conn.cursor()
cursor.execute('CREATE TABLE IF NOT EXISTS exploits (id INTEGER PRIMARY KEY, file TEXT, description TEXT, date TEXT, author TEXT, platform TEXT, type TEXT, port INTEGER)')
with open('exploits.csv', mode='r', encoding='utf-8') as f:
    reader = csv.DictReader(f)
    to_db = [(r['id'], r['file'], r['description'], r['date'], r['author'], r['platform'], r['type'], r['port']) for r in reader]
cursor.executemany('INSERT INTO exploits VALUES (?,?,?,?,?,?,?,?);', to_db)
conn.commit()
conn.close()
INNEREOF
          python forge_db.py

      - name: Commit and Push Database
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          mkdir -p data
          mv duck_base.db data/
          git add data/duck_base.db
          git commit -m "Arsenal update: $(date +'%Y-%m-%d')" || exit 0
          git push
